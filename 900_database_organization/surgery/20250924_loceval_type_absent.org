#+title: Loceval ++ Type Absent
#+date: 20250924


request by Tom / Ward to mark loceval where no local replacement cell was found.

* new column

#+begin_src sql :eval no
ALTER TABLE "outbound"."SampleUnits" ADD COLUMN type_is_absent boolean NOT NULL DEFAULT FALSE;
COMMENT ON COLUMN "outbound"."SampleUnits".type_is_absent IS E'unsuccessful local replacement / target type not found';

#+end_src

* hard-connect visits

tooling:
#+begin_src R

source("MNMLibraryCollection.R")
load_database_interaction_libraries()
source("MNMDatabaseConnection.R")
source("MNMDatabaseToolbox.R")

#+end_src


connection:
#+begin_src R
config_filepath <- file.path("./inbopostgis_server.conf")
# mirror <- "-staging"
mirror <- ""

# loceval database
locevaldb_mirror <- glue::glue("loceval{mirror}")

locevaldb <- connect_mnm_database(
  config_filepath,
  database_mirror = locevaldb_mirror
)
# keyring::keyring_delete(keyring = "mnmdb_temp")

message(glue::glue("connected: psql {locevaldb$shellstring}"))
#+end_src


#+begin_src sql
-- ALTER TABLE "inbound"."Visits" ALTER COLUMN fieldactivitycalendar_id TYPE int USING fieldactivitycalendar_id::integer;
ALTER TABLE "inbound"."Visits" ADD COLUMN fieldactivitycalendar_id int DEFAULT NULL;
COMMENT ON COLUMN "inbound"."Visits".fieldactivitycalendar_id IS E'link to calendar index (technical)';
-- foreign key fieldactivitycalendar_id
ALTER TABLE "inbound"."Visits" DROP CONSTRAINT IF EXISTS fk_FieldActivityCalendar_Visits CASCADE;
ALTER TABLE "inbound"."Visits" ADD CONSTRAINT fk_FieldActivityCalendar_Visits FOREIGN KEY (fieldactivitycalendar_id)
REFERENCES "outbound"."FieldActivityCalendar" (fieldactivitycalendar_id) MATCH SIMPLE
ON DELETE SET NULL ON UPDATE CASCADE;



ALTER TABLE "inbound"."Visits" ADD COLUMN stratum varchar DEFAULT NULL;
COMMENT ON COLUMN "inbound"."Visits".stratum IS E'stratum, as planned in the sampling procedure';

ALTER TABLE "inbound"."Visits" ADD COLUMN activity_group_id smallint DEFAULT NULL;
COMMENT ON COLUMN "inbound"."Visits".activity_group_id IS E'a link to the activity metadata';

ALTER TABLE "inbound"."Visits" ADD COLUMN date_start date DEFAULT NULL;
COMMENT ON COLUMN "inbound"."Visits".date_start IS E'start of the panel activity sequence';

#+end_src



#+begin_src R
visits <- locevaldb$query_table("Visits")
gact_id <- locevaldb$query_table("GroupedActivities") %>%
  filter(activity_group == "LOCEVALTERR") %>%
  pull(activity_group_id)
facal <- locevaldb$query_table("FieldActivityCalendar") %>%
  filter(activity_group_id == gact_id)

visits %>% count(grts_address, sampleunit_id) %>% arrange(desc(n))
facal %>% count(grts_address, sampleunit_id) %>% arrange(desc(n))

facal <- facal %>% filter(!is.na(stratum))

visits_filled <- visits %>%
  select(
      -fieldactivitycalendar_id,
      -stratum,
      -activity_group_id,
      -date_start
         ) %>%
  inner_join(
    facal %>%
    select(
      grts_address,
      sampleunit_id,
      fieldactivitycalendar_id,
      stratum,
      activity_group_id,
      date_start
    ),
    by = join_by(grts_address, sampleunit_id),
    relationship = "one-to-one"
  ) %>%
  select(
    visit_id,
    grts_address,
    sampleunit_id,
    fieldactivitycalendar_id,
    stratum,
    activity_group_id,
    date_start
  )

visits_filled %>%
  filter(is.na(stratum)) %>%
  knitr::kable()

update_existing_data(
    mnmdb = locevaldb,
    table_label = "Visits",
    changed_data = visits_filled,
    input_precedence_columns = c(
      "teammember_id",
      "date_visit",
      "type_assessed",
      "notes",
      "photo",
      "visit_done"
    ),
    index_columns = c("visit_id"),
    reference_columns = c("grts_address", "sampleunit_id")
  )

#+end_src


#+begin_src R

stitch_table_connection(
  mnmdb = locevaldb,
  table_label = "Visits",
  reference_table = "FieldActivityCalendar",
  link_key_column = "fieldactivitycalendar_id",
  lookup_columns = c("grts_address", "stratum", "activity_group_id", "date_start")
)


stitch_table_connection(
  mnmdb = locevaldb,
  table_label = "Visits",
  reference_table = "SampleUnits",
  link_key_column = "sampleunit_id",
  lookup_columns = c("grts_address", "stratum"),
  reference_mod = function(ref) ref %>% rename(stratum = type)
)


stitch_table_connection(
  mnmdb = locevaldb,
  table_label = "FieldActivityCalendar",
  reference_table = "SampleUnits",
  link_key_column = "sampleunit_id",
  lookup_columns = c("grts_address", "stratum"),
  reference_mod = function(ref) ref %>% rename(stratum = type)
)
#+end_src


--  DELETE FROM "inbound"."Visits" WHERE fieldactivitycalendar_id IS NULL;
set NOT NULL:
#+begin_src sql
ALTER TABLE "inbound"."Visits" ALTER COLUMN fieldactivitycalendar_id SET NOT NULL;
#+end_src

* views

adjust LocationEvaluation

* fill column
