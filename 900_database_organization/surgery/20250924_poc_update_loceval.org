
I have neglected =loceval= for a while.

* POC changes
** domain partition

introduced by Floris

#+begin_src sql
-- add domain part to loceval
-- ALTER TABLE "outbound"."FieldActivityCalendar" ADD COLUMN domain_part varchar;
-- COMMENT ON COLUMN "outbound"."FieldActivityCalendar".domain_part IS E'domain partition';
-- TODO is this an attribute of SampleUnits?


-- add domain part to mnmgwdb
ALTER TABLE "outbound"."SampleUnits" ADD COLUMN domain_part varchar;
COMMENT ON COLUMN "outbound"."SampleUnits".domain_part IS E'domain partition';

#+end_src

** extra SampleUnit Info

#+begin_src sql :eval no
ALTER TABLE "outbound"."SampleUnits" ADD COLUMN is_forest bool NOT NULL DEFAULT FALSE;
COMMENT ON COLUMN "outbound"."SampleUnits".is_forest IS E'flag forest type sample units';

ALTER TABLE "outbound"."SampleUnits" ADD COLUMN in_mhq_samples bool NOT NULL DEFAULT FALSE;
COMMENT ON COLUMN "outbound"."SampleUnits".in_mhq_samples IS E'flag sites used for MHQ';

ALTER TABLE "outbound"."SampleUnits" ADD COLUMN has_mhq_assessment bool NOT NULL DEFAULT FALSE;
COMMENT ON COLUMN "outbound"."SampleUnits".has_mhq_assessment IS E'(temporary) column to filter MHQ polygons';

#+end_src

** wait_<more>


#+begin_src sql :eval no

ALTER TABLE "outbound"."FieldActivityCalendar" DROP COLUMN landowner;
ALTER TABLE "outbound"."FieldActivityCalendar" ADD COLUMN wait_any boolean;
COMMENT ON COLUMN "outbound"."FieldActivityCalendar".wait_any IS E'must I always be waiting, waiting on you? *whistle*';

ALTER TABLE "outbound"."FieldActivityCalendar" ADD COLUMN wait_floating boolean;
COMMENT ON COLUMN "outbound"."FieldActivityCalendar".wait_floating IS E'filter field for convenient floating type (de)selection';



#+end_src



* Versions
we now store the POC versions

subprocedure: Versions

#+begin_src sql

SET standard_conforming_strings = ON;
-- SET search_path TO pg_catalog,public,"metadata";

DROP TABLE IF EXISTS "metadata"."Versions" CASCADE;

BEGIN;
CREATE TABLE "metadata"."Versions"();

COMMENT ON TABLE "metadata"."Versions" IS E'storing the POC versions which caused the data';

ALTER TABLE "metadata"."Versions" ADD COLUMN version_id smallint NOT NULL PRIMARY KEY;
COMMENT ON COLUMN "metadata"."Versions".version_id IS E'version index (technical)';

ALTER TABLE "metadata"."Versions" ADD COLUMN version_tag varchar NOT NULL;
COMMENT ON COLUMN "metadata"."Versions".version_tag IS E'tag version in human-readable format';

ALTER TABLE "metadata"."Versions" ADD COLUMN data_iteration integer;
COMMENT ON COLUMN "metadata"."Versions".data_iteration IS E'repeated data updates without version tag change';

ALTER TABLE "metadata"."Versions" ADD COLUMN date_applied integer;
COMMENT ON COLUMN "metadata"."Versions".date_applied IS E'date when the data was uploaded';

ALTER TABLE "metadata"."Versions" ADD COLUMN notes text;
COMMENT ON COLUMN "metadata"."Versions".notes IS E'relevant notes on this change';

COMMIT;

-- sequence version_id
CREATE SEQUENCE "metadata".seq_version_id
INCREMENT BY 1
MINVALUE 0
MAXVALUE 2147483647
START WITH 1
CACHE 1
NO CYCLE
OWNED BY "metadata"."Versions".version_id;
ALTER TABLE "metadata"."Versions" ALTER COLUMN version_id
 SET DEFAULT nextval('metadata.seq_version_id'::regclass);

GRANT USAGE ON SEQUENCE "metadata"."seq_version_id" TO floris, karen, ward, monkey;
GRANT SELECT ON SEQUENCE "metadata"."seq_version_id" TO monkey;
GRANT SELECT ON "metadata"."Versions" TO floris, karen, ward, monkey;


-- GRANT USAGE ON SEQUENCE "metadata"."seq_version_id" TO tester;
-- GRANT SELECT ON "metadata"."Versions" TO tester;
ALTER TABLE "outbound"."SampleUnits" DROP COLUMN IF EXISTS archive_version_id;
ALTER TABLE "outbound"."SampleUnits" ADD COLUMN archive_version_id smallint DEFAULT NULL;
COMMENT ON COLUMN "outbound"."SampleUnits".archive_version_id IS E'(technical) archived SampleUnits are retained but flagged';



-- foreign key archive_version_id
ALTER TABLE "outbound"."SampleUnits" DROP CONSTRAINT IF EXISTS fk_Versions_SampleUnits CASCADE;
ALTER TABLE "outbound"."SampleUnits" ADD CONSTRAINT fk_Versions_SampleUnits FOREIGN KEY (archive_version_id)
REFERENCES "metadata"."Versions" (version_id) MATCH SIMPLE
ON DELETE SET NULL ON UPDATE CASCADE;



ALTER TABLE "outbound"."FieldActivityCalendar" DROP COLUMN IF EXISTS archive_version_id;

ALTER TABLE "outbound"."FieldActivityCalendar" ADD COLUMN archive_version_id smallint DEFAULT NULL;
COMMENT ON COLUMN "outbound"."FieldActivityCalendar".archive_version_id IS E'(technical) flag archived calendar entries';
-- foreign key archive_version_id
ALTER TABLE "outbound"."FieldActivityCalendar" DROP CONSTRAINT IF EXISTS fk_Versions_FieldActivityCalendar CASCADE;
ALTER TABLE "outbound"."FieldActivityCalendar" ADD CONSTRAINT fk_Versions_FieldActivityCalendar FOREIGN KEY (archive_version_id)
REFERENCES "metadata"."Versions" (version_id) MATCH SIMPLE
ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "inbound"."Visits" DROP COLUMN IF EXISTS archive_version_id;
ALTER TABLE "inbound"."Visits" ADD COLUMN archive_version_id smallint DEFAULT NULL;
COMMENT ON COLUMN "inbound"."Visits".archive_version_id IS E'(technical) flagged archived visits';
-- foreign key archive_version_id
ALTER TABLE "inbound"."Visits" DROP CONSTRAINT IF EXISTS fk_Versions_Visits CASCADE;
ALTER TABLE "inbound"."Visits" ADD CONSTRAINT fk_Versions_Visits FOREIGN KEY (archive_version_id)
REFERENCES "metadata"."Versions" (version_id) MATCH SIMPLE
ON DELETE SET NULL ON UPDATE CASCADE;


#+end_src


* Protocols

subprocedure: Protocols
>>> [[file:./20250904_Protocols.sql]]

-> MANUALLY update the Protocols table once.
>>> [[file:../078_update_protocols.qmd]]

* column adjustments

* Stitch Lookups

... to reduce off-focus updates during POC update

>>> [[file:../095_re_link_foreign_keys_optional.R]]


* POC update =v0.9.0_poc0.13.1=

>>> [[file:../071_POC_update_loceval.qmd]]



* auxiliary maintenance scripts
... all of them, just to make sure.

* TODO

