#+title: 005 Photos


#+begin_src sh :eval no :tangle no
mkdir new_photos && find . \( -iname '*.jpg' -o -iname "*.png" \) -exec cp -p "{}" ./new_photos  \;
#+end_src

#+begin_src sh :eval no :tangle no

find ./photos_highres -iname '*.jpg' -exec convert \{\} -verbose -set filename "%[basename].%[extension]" -resize 640x640^ -quality 80% \> "./DCIM/%[filename]" \;
find ./photos_highres -iname '*.png' -exec convert \{\} -verbose -set filename "%[basename].%[extension]" -resize 640x640^ -quality 15 \> "./DCIM/%[filename]" \;
#+end_src


#+begin_src python :eval no :tangle grab_incoming_photos.py

#!/usr/bin/env python3

### libraries
import os as OS
import pathlib as PL
from tqdm import tqdm as PB

### paths
base_path = PL.Path('/data/qgis_projects')
incoming = base_path / 'photos_incoming'
out_dir  = base_path / 'photos_highres'
dcim_dir = base_path / 'DCIM'

### find files
# some files are not used
unused_dir = out_dir/"unused"
unused_files = [ufi.name for ufi in unused_dir.rglob("*")]

# others were done before
done_dir = out_dir/"done"
done_files = [ufi.name for ufi in unused_dir.rglob("*")]

all_files = list(incoming.rglob("*.png")) \
    + list(incoming.rglob("*.jpeg")) \
    + list(incoming.rglob("*.jpg"))

new_files = [fi for fi in all_files
             if fi.name not in unused_files + done_files]


### copy novel | bigger files
for p in PB(new_files):
    # print(p, p.name, OS.path.getsize(p))
    in_file = p
    in_size = OS.path.getsize(p) 
    out_file = out_dir / p.name
    out_exists = out_file.exists() 
    out_size = OS.path.getsize(out_file) if out_exists else 0 

    if in_size > out_size:
        # print(in_file, in_size, out_file, out_size)
        OS.system(f"cp -p '{in_file}' '{out_dir}/'")


### convert
convert_command = """convert \\{\\} -verbose -set filename "%[basename].%[extension]" -resize 640x640^ -quality 80% \\>"""
OS.system(f"""find {out_dir} -maxdepth 1 -type f -iname '*' -exec {convert_command} "{dcim_dir}/%[filename]" \\;""")

### distribute
for db_name in ["loceval", "mnmgwdb"]:
    OS.system(f"rm -rf {base_path/db_name/'DCIM'} && cp -R {dcim_dir} {base_path/db_name}/ ")
    
#+end_src
