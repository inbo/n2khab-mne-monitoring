sql,deactivated
"ALTER TABLE ""metadata"".""GroupedActivities"" ADD CONSTRAINT uq_activities UNIQUE (activity_group, activity);",
BEGIN;COMMIT;,"-- ALTER TABLE ""outbound"".""fieldworkcalendar"" ADD CONSTRAINT check_loccal_activity_groups CHECK ( activity_group_id IN (SELECT DISTINCT activity_group_id FROM ""metadata"".""GroupedActivities"" GROUP BY activity_group_id )); -- not possible :("
"DROP FUNCTION IF EXISTS ""public"".""sync_mod"" CASCADE;CREATE FUNCTION sync_mod() RETURNS trigger AS $sync_mod$BEGIN  NEW.log_update := current_timestamp;  NEW.log_user := current_user;  RETURN NEW  ;END;$sync_mod$ LANGUAGE plpgsql;DROP TRIGGER IF EXISTS log_locationinfos ON ""outbound"".""LocationInfos"";CREATE TRIGGER log_locationinfosBEFORE UPDATE ON ""outbound"".""LocationInfos""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_fieldworkcalendar ON ""outbound"".""FieldworkCalendar"";CREATE TRIGGER log_fieldworkcalendarBEFORE UPDATE ON ""outbound"".""FieldworkCalendar""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_visits ON ""inbound"".""Visits"";CREATE TRIGGER log_visitsBEFORE UPDATE ON ""inbound"".""Visits""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_wellinstallationactivities ON ""inbound"".""WellInstallationActivities"";CREATE TRIGGER log_wellinstallationactivitiesBEFORE UPDATE ON ""inbound"".""WellInstallationActivities""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_chemicalsamplingactivities ON ""inbound"".""ChemicalSamplingActivities"";CREATE TRIGGER log_chemicalsamplingactivitiesBEFORE UPDATE ON ""inbound"".""ChemicalSamplingActivities""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_spatialpositioningactivities ON ""inbound"".""SpatialPositioningActivities"";CREATE TRIGGER log_spatialpositioningactivitiesBEFORE UPDATE ON ""inbound"".""SpatialPositioningActivities""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_freefieldnotes ON ""inbound"".""FreeFieldNotes"";CREATE TRIGGER log_freefieldnotesBEFORE UPDATE ON ""inbound"".""FreeFieldNotes""FOR EACH ROW EXECUTE PROCEDURE sync_mod();DROP TRIGGER IF EXISTS log_fieldfollowups ON ""inbound"".""FieldFollowUps"";CREATE TRIGGER log_fieldfollowupsBEFORE UPDATE ON ""inbound"".""FieldFollowUps""FOR EACH ROW EXECUTE PROCEDURE sync_mod();",-- update triggers to log user and modification time
"ALTER TABLE ""metadata"".""LocationCells"" DROP CONSTRAINT IF EXISTS fk_Locations_LocationCells CASCADE;ALTER TABLE ""metadata"".""LocationCells"" ADD CONSTRAINT fk_Locations_LocationCells FOREIGN KEY (location_id)REFERENCES ""metadata"".""Locations"" (location_id) MATCH SIMPLEON DELETE CASCADE ON UPDATE CASCADE;",-- location_cells must delete on locations cascade (non-null constraint for foreign key is difficult)
"CREATE SEQUENCE ""inbound"".seq_fieldwork_idINCREMENT BY 1MINVALUE 0MAXVALUE 2147483647START WITH 1CACHE 1NO CYCLE;",-- shared sequence for multiple fieldwork activity tables
"GRANT USAGE ON SEQUENCE ""inbound"".""seq_fieldwork_id"" TO tom,yglinga,jens,lise,wouter,floris,karen,falk;",
"GRANT SELECT ON SEQUENCE ""inbound"".""seq_fieldwork_id"" TO ward,monkey;",
"ALTER TABLE ""inbound"".""WellInstallationActivities"" ALTER COLUMN fieldwork_id SET DEFAULT nextval('inbound.seq_fieldwork_id'::regclass);",
"ALTER TABLE ""inbound"".""ChemicalSamplingActivities"" ALTER COLUMN fieldwork_id SET DEFAULT nextval('inbound.seq_fieldwork_id'::regclass);",
"ALTER TABLE ""inbound"".""SpatialPositioningActivities"" ALTER COLUMN fieldwork_id SET DEFAULT nextval('inbound.seq_fieldwork_id'::regclass);",
BEGIN;COMMIT;,"-- ALTER TABLE ""outbound"".""FieldworkCalendar"" DROP CONSTRAINT ""FieldworkCalendar_pkey"" CASCADE;"
BEGIN;COMMIT;,"-- ALTER TABLE ""inbound"".""Visits"" DROP CONSTRAINT ""Visits_pkey"" CASCADE;"
"ALTER TABLE ""metadata"".""Protocols"" ADD CONSTRAINT uq_protocol UNIQUE (protocol_code, protocol_version);",-- unique protocol version
