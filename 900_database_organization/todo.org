#+title: TODO

* mainline
+ [X] credentials to config
+ [X] =UNIQUE= tag? -> constraints added
+ [-] migration and real test
  + [X] activity calendar
  + [X] activities executed -> "Visits"
  + [X] stratum to LocCal
  + [ ] a unique identifier for =fag_stratum_grts_calendar_2025_attribs_sf= (fag+grts? database?)
  + [X] there are unmatched *activities* (join) -> define meaningful set of activities with human-readable description
  + [X] there are non-unique LocationCalendar entries, smushed before upload
  + [X] handle *teammembers* (meta data table); e.g. for planning =Visits=
+ [X] test import to =pgmodeler= for visualization
+ [X] Visits: outsource a table with "locations due", linking to LocationCalendar
  + [X] subset which is due for a visit
  + [X] different schema -> it might be necessary to lookup schema in the python generator procedure
  + [X] date scheduled; user assigned -> via desktop work (qgis project)
  + [X] +regularly updated with stored procedure or python script+ auto-pushed
  + [X] column "done" is fed back to LocationCalendar
+ [X] play with "read/write" permissions of user role =ward= via qgis/qfield
  + [X] sequence references seem to be an issue (ROLE->SEQUENCE?)
+ [X] =teammember_id=:
  + [X] =teammember_id= columns
  + [X] or dropdown for form edit (=Teammembers= table ⊂ =metadata= schema?)
+ [X] inbound forms
  + [X] =Visits= -> structured input
  + [X] =FieldNotes= -> free input
+ [X] something wrong with python =getpasswd=

+ [ ] remove ="FieldActivityCalendar".grts_join_method=
+ [ ] rename ="FieldActivityCalendar".acceccibility_revisit=
+ [ ] overhaul =ExtraVisits= -> multi visits per location
  + grouped_activity_id

+ [X] loceval fieldwork app
  + [X] replacement procedure
  + [X] filter "priority"
  + [X] days to deadline (=date_end=)
  + [X] view on =LocationCells= to show only those in sample


+ [ ] weird cells in ofo's
  + [ ] grts 2006953 has a direct neighbor
  + [ ] type labels have changed (e.g. =2190_mp= -> =2190_a=)
  + [ ] grts 681846 is a totally different type (6230 -> 3150)

+ [ ] POC pipeline
  + [ ] functional modularization suggestions for code snippets
  + [ ] =units_cell_polygon= are there other relevant polygons in there?
  + [ ] replacements by stratum?
  + [ ] in-memory rollback upon failed updates


+ [-] 20250704 loceval post mortem
  + [X] review the "POC Update" procedure (++ExtraVisits)
  + [ ] new locations to assess??
    + recover old RData and compare
  + [X] "verouderd" field is rubbish -> correct OrthophotoAssessment view
  + [X] loc_id mismatch: "schietveld" in Hemiksem?
  + [ ] combined UNIQUE constraints for all characteristic columns
  + [X] reset sequences on tabula rasa / DELETE+INSERT updates


+ [ ] re-check POC update script (=070_=)
  + [ ] add other databases
+ [X] extra types (vraag Floris)

+ [ ] backup procedures
  + [ ] daily backups to S3
+ [ ] scripts for user management
+ [ ] list WCS/WFS/WMS sources
+ [ ] random points in target area for well placement
+ [X] re-upload bug -> was fk

+ [ ] info from LocationAssessment
+ [ ] landuse/ownership: one categorical field

+ [ ] meeting @TDD @WT @KW @FV @FM <2025-07-02 Wed> MNM Fieldwork Outbound/Planning app
  + [ ] INBO arcgis -> qgis via web services?
  + [ ] n2khab_strata ++allow NULL
  + [ ] move all =waiting_= types to a separate layer clone
  + [ ] type -> stratum for all except Ward (see separate email)
    + doubling by re-join of scheme
    + loceval: strata temporally and spatially separated -> no join of =scheme_panelset=
    + for GW app: summarized
      + e.g. =fag_{,_stratum}_grts_calendar
  + revisit =grts_address=
  + [ ] ++fac_rank
  + [ ] ++ field =praktische_info=
  + [ ] ++ field =accessibility=
  + [ ] required map layers @TDD:
    + laadpalen
    + land owner
    + topo map (osm, google)
    + watina summary layer
    + bodemkaart
    + woonplaats medewerkers

+ [ ] WATINA summary layer
  + [ ] naming a priori by Tom; provide voronoi polygon layer

+ [-] Fieldwork Planning app
  + [X] database structure basic
  + [ ] upload data
  + [ ] qgis-directed views
  + [ ] qgis project
  + [ ] local replacement view
  + [ ] ++ GroupedActivities {=module=, =scheme=}?
  + [ ] option to add activities / rows in FieldActivityPlanner?
  + [ ] pull watina info

+ [-] input meeting @WT @KW @FV @FM <2025-06-24 Tue>
  + [X] decoupling LocCal - Visits!!
  + [X] =ortophoto_2025_cells= and =ortophoto_2025_cellcenters=
  + [X] orthophotos:
    + via "datavindplaats" -> wcs/wfs
    + winter && summer
  + [X] use =grts_address_final=
  + [X] =ortophoto_2025_type_grts=
    + assessment
    + sp_poststratum
    + scheme_ps_targetpanels
  + [X] ++ fields
    + cel afgekeurd
    + natuur/niet
    + tijdelijk verloren
    + implications polygon/habmap; feedback habitatkaart
  + [X] landuse
    + ANB
    + landbouw
  + [ ] location qgis projects
  + [X] habmap: use 2023 fixed version; later: preliminary update by @FV
  + [ ] protocol-like criteria by @WT
  + [-] qgis design
    + [X] types -> qgis map label
    + [X] "activity" visible in form
    + [ ] test attribute table sorting
    + [X] add habitatmap (raw; wfs?) as background layer

+ [ ] exclude admin from =log_= rules
+ [-] suggestions @FV <2025-06-18 Wed>
  + [ ] subset habitat_types (wait input)
  + [X] +activity_sequence+ -> =activity_rank=
  + [X] idem =replacement_rank=
  + [X] remove =targetpanel=; replace by =fieldwork_2025_priorities= + =stratum_scheme_ps_targetpanel= (for Tom)
  + [ ] replacements: base on non-=_final= =grts_address=
  + [X] +stratum+ -> =type= (convert via =n2khab_strata=)
  + [X] =stratum_to_expect= -> =type_adjusted=
  + [X] =stratum_corrected= -> =type_assessed=
  + [X] corner points or polygons for sample units (also depends on type)
  + [ ] two replacement procedures: =local replacement= vs. drop-out ( ↖sampling)
  + [ ] there was a table (replacements?) with inconsistent pk name
+ [ ] request Tom: also get Watina datalayers
+ [ ] test gps data collection via qfield
  + [ ] coordinates
  + [ ] elevation measurements
+ recurrent tasks
  + [X] backup procedures via cron
  + [ ] =Visits=: due/overdue update
+ [X] forms refinement
  + [X] aliases? (via postgres or qfield)
+ [ ] accessibility/land ownership layer
+ [ ] database mirrors: one for me to play (=loceval_dev=), one for staging (=loceval_testing=), with copy of the one for the real work (=loceval=)
  + [ ] safe checks for updating a production database
+ [-] qgis/database convenience
  + [X] fill username automatically upon edit
  + [X] store edit dates -> "append-only" + views?
  + [ ] inbound project: view to join activities and protocols
+ [ ] second db with third schema: =mnmdb=
  + [ ] mirror/assembly of previously collected data
  + [ ] can live on a completely different connection
  + [ ] replace image blobs with file links upon import
+ [X] images and how to bring them home
  + [X] BLOB (binary large objects) work as =bytea= data type [[https://www.postgresql.org/docs/current/datatype-binary.html][(see here)]]
  + [X] test qfield camera usage
  + [X] test downloading and compression/update workflow
  + [X] solved [[https://docs.qfield.org/how-to/pictures/][via qfield attachments]]; folder export/sync necessary
+ [ ] generalize R functions, to package files
  + =append_tabledata=
  + =upload_and_lookup=
+ [-] qfield integration
  + [X] where is the qgis qfield export gone? *[!]* -> gdal error solved
  + [ ] postgis login from qfield; auth with master password? set ID!
  + [ ] [[https://docs.qfield.org/how-to/pictures/#drawing-templates][qfield drawing templates]]
  + [X] [[https://docs.qfield.org/how-to/pictures/#configurable-attachment-path][attachment path]]
  + [X] select/join from multiple tables; alternatively auto-generate data+metadata -> postgres views views
+ [ ] try qfield folder on shared gdrive
  + [ ] try gdrive access with different roles
  + [ ] provide offline alternatives
+ [ ] generic database ROLEs (extra layer btw db user and permission; simplifies adding new database users to certain tasks)
  + [ ] roles defined
  + [ ] adjust upload scripts
+ [ ] Activity Roles
  + [ ] for now: solved by group members in =TeamMembers=
  + [ ] add =role= to =TeamMembers=
  + [ ] link =GroupedActivities= to roles -> who does what? filter?
+ [X] offline caching in qfield? -> works well
+ [X] bring to tablet
+ [ ] manual, ex post python check to constrain =LocationCalendar.activity_group_id= to valid values
+ [X] fix qgis installation
+ [ ] migrate to AWS: database + ec2 + s3
  + [ ] backups to s3
  + [ ] create postgis docker for db
    + user handling?
    + updates?
  + [ ] organize with ICT/Jens (timing!)
  + [ ] backup and maintenance procedures to ec2
  + [ ] keep current node for =*_dev=
+ [ ] fieldwork roles [[https://docs.google.com/spreadsheets/d/1wFbevEcaNbQ1RBIwEdkoloRYmarQ59E2gctbcxVyH_M/edit?gid=0#gid=0][gsheet]]
+ [ ] email services on the server to send backup logs & errors
+ [ ] consider function-related schema's (e.g. "orthophoto")
+ [ ] meta table storing (current and previous) POC verisons
+ [ ] users may choose their passwords
  + [ ] via "alter role" script in python or R

* issue anticipation
** connectivity
+ offline sattelite image layer?
+ transient replacement procedure requires connection to server
  + can we get joins in layers? -> filter a view-like layer
  + provide alternative tool for local use on laptop/tablet?

** TODO dplyr
copy all -> processing inbound.FreeFieldNotes
#+begin_quote
Warning message:
Using `by = character()` to perform a cross join was deprecated in dplyr 1.1.0.
ℹ Please use `cross_join()` instead.
#+end_quote

* optional
+ save/restore a whole =db_structure= in pandas tables
+ check =wk::as_wkb()=
    #+begin_quote
    Een beetje experimentering met database-geometrieën vind je in deze code <https://github.com/inbo/n2khab-preprocessing/blob/1bf89599398b1b1be121fe84dcedec5623a8a576/src/miscellaneous/watersurfaces.Rmd#L76-L120>.
    Inspiratie kwam van https://hydroecology.net/reading-spatial-data-from-sql-server-without-sf/
    #+end_quote

+ array data types (e.g. =panel_set=) -> upload with dplyr tricky (str -> int[])

+ bug report: =sf::dbWriteTable()= seems to overwrite boolean defaults

+ logseq project in the folder -> document database processes
